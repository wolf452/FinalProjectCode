pipeline {
    agent any

    environment {
        ANSIBLE_DIR = 'ansible' // مسار ملفات أنسبل
        AWS_ACCESS_KEY_ID = credentials('aws-access-key') // بيانات الاعتماد للوصول إلى AWS
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-key') // بيانات الاعتماد للوصول إلى AWS
        AWS_REGION = 'us-east-1' // تحديد منطقة AWS
        PRIVATE_KEY_FILE = './ivolve.pem' // مسار مفتاح SSH الخاص
    }

    stages {
        stage('Checkout Code') { // مرحلة جلب الكود من Git
            steps {
                git branch: 'main', url: 'https://github.com/wolf452/FinalProjectCode.git'
            }
        }
        stage('Run Ansible Playbook') { // مرحلة تشغيل Playbook
            steps {
                dir("${ANSIBLE_DIR}") { // الانتقال إلى دليل الأنسبل
                    script {
                        // إنشاء ملف الـ Inventory
                        sh '''
                        cat > inventory <<EOL
[ec2]
3.92.196.95 ansible_user=ubuntu ansible_ssh_private_key_file=${PRIVATE_KEY_FILE}
EOL
                        '''

                        // تعديل صلاحيات مفتاح SSH
                        sh 'chmod 400 ${PRIVATE_KEY_FILE}'

                        // تشغيل الـ Playbook
                        sh 'ansible-playbook -i inventory playbook.yml'
                    }
                }
            }
        }
    }
}
